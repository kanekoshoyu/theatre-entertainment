app.controller("CampaignCtrl",["$timeout","$http","$element","$anchorScroll","$routeParams","$rootScope","$scope","$filter","$translatePartialLoader","$translate","$window","PortalSettingsService","RESOURCE_REGIONS","Restangular","$route","$location","UserService","DisqusShortnameService","RestFullResponse","API_URL","redirectService","RequestCacheService","CampaignSettingsService","$sce","ANONYMOUS_COMMENT","SOCIAL_SHARING_OPTIONS","VideoLinkService",function($timeout,$http,$element,$anchorScroll,$routeParams,$rootScope,$scope,$filter,$translatePartialLoader,$translate,$window,PortalSettingsService,RESOURCE_REGIONS,Restangular,$route,$location,UserService,DisqusShortnameService,RestFullResponse,API_URL,redirectService,RequestCacheService,CampaignSettingsService,$sce,ANONYMOUS_COMMENT,SOCIAL_SHARING_OPTIONS,VideoLinkService){function setVote(){Restangular.one("campaign/"+$scope.campaign_id+"/comment/"+$scope.comment_action.comment_id+"/comment-action").customPOST($scope.comment_action).then(function(success){$scope.getComments()})}function getCampaign(){Restangular.one("campaign").customGET($scope.campaign_id,{use_path_lookup:/campaign\/private/.test($rootScope.currentLoc)?1:0,path:$rootScope.currentLoc.substring(1)}).then(function(success){function setMeta(){for(var metaTags=[{type:"name",name:"author",content:$scope.campaign.managers[0].first_name},{type:"name",name:"keyword",content:$scope.campaign.categories?$scope.campaign.categories[0].name:""},{type:"name",name:"description",content:$scope.campaign.blurb||""}],i=0;i<metaTags.length;i++){var meta="<meta ";meta+=metaTags[i].type,meta+=" = '",meta+=metaTags[i].name,meta+="' content = '",meta+=metaTags[i].content,meta+="' class='jMeta'> \n",$("meta[property]").first().before(meta),(metaTags[i].type="description")&&($rootScope.ogMeta.description=metaTags[i].content)}}$location.hash()&&$timeout(function(){$anchorScroll()}),$scope.profileTypes=[{name:"Campaign",profile_type_id:1},{name:"FAQ",profile_type_id:2},{name:"Backers",profile_type_id:3},{name:"Streams",profile_type_id:4},{name:"Comments",profile_type_id:5}],$scope.campaign=success,$scope.embed_path=$location.absUrl(),$scope.embed_path=$scope.embed_path.replace(window.b,"/embed/card-view/"+$scope.campaign.entry_id),CampaignSettingsService.processSettings($scope.campaign.settings);var campaignSettings=CampaignSettingsService.getSettings();if(null==campaignSettings||!campaignSettings.enable_rewards_pagination&&campaignSettings.hasOwnProperty("enable_rewards_pagination")?$scope.rewardPagination={page:1,page_entries:9999,pagination:{numpages:1}}:($scope.progressHide=!1,$scope.public_settings.site_campaign_progress_bar_hide?$scope.progressHide=$scope.public_settings.site_campaign_progress_bar_hide:$scope.progressHide=$scope.public_settings.site_campaign_progress_bar_hide,"undefined"!=typeof campaignSettings.progress_bar_hide&&($scope.progressHide=campaignSettings.progress_bar_hide),$scope.rewardPagination={page:1,page_entries:5,pagination:{numpages:1}}),$scope.campaign.pledges){var requiredNumCalls=parseInt($scope.campaign.pledges.length/$scope.rewardPagination.page_entries);$scope.campaign.pledges.length%$scope.rewardPagination.page_entries!=0&&(requiredNumCalls+=1),$scope.rewardPagination.pagination.numpages=requiredNumCalls,$scope.filterRewards()}switch($scope.public_settings.site_campaign_sharing_options){case SOCIAL_SHARING_OPTIONS.sharing_users:$scope.is_sharing_available=!0;break;case SOCIAL_SHARING_OPTIONS.sharing_backers:$scope.is_sharing_available=!1,$scope.campaign.managers[0].id!=$scope.user.id&&1!=$scope.user.person_type_id||($scope.is_sharing_available=!0);break;case SOCIAL_SHARING_OPTIONS.sharing_disabled:$scope.is_sharing_available=!1;break;default:$scope.is_sharing_available=!0}"undefined"!=typeof $scope.public_settings.site_campaign_exclude_shipping_cost&&$scope.public_settings.site_campaign_exclude_shipping_cost&&($scope.campaign.funded_amount=$scope.campaign.funded_amount-$scope.campaign.total_shipping_cost),angular.forEach($scope.campaign.settings,function(value,index){var setting_name=value.name,setting_value=value.value;"name"!=setting_name&&($scope.campaign[setting_name]=setting_value,$scope.campaign.profile_type_view_id||($scope.campaign.profile_type_view_id=0))}),native_lookup&&$scope.campaign.cities&&$scope.campaign.cities.forEach(function(value){getNativeName(value)}),CampaignSettingsService.setCampaignId($scope.campaign_id),CampaignSettingsService.processSettings(success.settings),$scope.campaign.settings=CampaignSettingsService.getSettings(),$scope.campaign.settings.top_header_link&&$scope.campaign.settings.top_header_link.length<=0&&($scope.campaign.settings.top_header_link="#"),"#"==$scope.campaign.settings.top_header_link&&delete $scope.campaign.settings.top_header_link,$scope.campaign.settings.google_analytics_id&&setGACode($scope.campaign.settings.google_analytics_id),setMeta(),$scope.remaining_time=$scope.campaign.time_remaining,$scope.days_rem=$scope.campaign.days_remaining_inclusive,$scope.campaign.timezoneText=moment().tz($scope.campaign.timezone).zoneAbbr(),$translate(["seconds_to_go","second_to_go","seconds_ago","second_ago","minutes_to_go","minute_to_go","minutes_ago","minute_ago","hours_to_go","hour_to_go","hours_ago","hour_ago"]).then(function(values){0==$scope.days_rem?($scope.days_rem=$scope.campaign.hours_remaining_inclusive,0==$scope.days_rem?($scope.days_rem=$scope.campaign.minutes_remaining_inclusive,0==$scope.days_rem?($scope.days_rem=$scope.campaign.seconds_remaining_inclusive,$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=values.seconds_to_go:$scope.day_text=values.second_to_go:($scope.days_rem=$scope.days_rem*-1,$scope.days_rem>1?$scope.day_text=values.seconds_ago:$scope.day_text=values.second_ago)):$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=values.minutes_to_go:$scope.day_text=values.minute_to_go:($scope.days_rem=$scope.days_rem*-1,$scope.days_rem>1?$scope.day_text=values.minutes_ago:$scope.day_text=values.minute_ago)):$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=values.hours_to_go:$scope.day_text=values.hour_to_go:($scope.days_rem=$scope.days_rem*-1,$scope.days_rem>1?$scope.day_text=values.hours_ago:$scope.day_text=values.hour_ago)):$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=" days to go":$scope.day_text=" day to go":($scope.days_rem=$scope.days_rem*-1,$scope.days_rem>1?$scope.day_text="days ago":$scope.day_text="day ago")});var end=(moment(),moment($scope.campaign.ends)),d1=moment($scope.campaign.starts),d2=moment();moment.duration(d2.diff(end)).asMinutes();if(moment($scope.campaign.ends)<moment(new Date)?($scope.min=Math.abs(moment.duration(end.diff(d1)).asMinutes()),$scope.days=Math.abs(moment.duration(end.diff(d1)).asDays()),$scope.hours=Math.abs(moment.duration(end.diff(d1)).asHours()),$scope.week=Math.abs(moment.duration(end.diff(d1)).asWeeks()),$scope.month=Math.abs(moment.duration(end.diff(d1)).asMonths())):($scope.min=moment.duration(d2.diff(d1)).asMinutes(),$scope.days=moment.duration(d2.diff(d1)).asDays(),$scope.hours=moment.duration(d2.diff(d1)).asHours(),$scope.week=moment.duration(d2.diff(d1)).asWeeks(),$scope.month=moment.duration(d2.diff(d1)).asMonths()),$scope.month>1?($scope.duration=parseInt($scope.month),$scope.month>1&&$scope.month<2?$scope.dtype="month":$scope.dtype="months"):$scope.week>1?($scope.duration=parseInt($scope.week),$scope.week>1&&$scope.week<2?$scope.dtype="week":$scope.dtype="weeks"):$scope.days>1?($scope.duration=parseInt($scope.days),$scope.days>1&&$scope.days<2?$scope.dtype="day":$scope.dtype="days"):$scope.hours>1?($scope.duration=parseInt($scope.hours),$scope.hours>1&&$scope.hours<2?$scope.dtype="hour":$scope.dtype="hours"):$scope.min>1&&($scope.duration=parseInt($scope.min),$scope.min>1&&$scope.min<2?$scope.dtype="min":$scope.dtype="mins"),msg={header:"Maximum funding goal has been reached for this campaign"},$scope.campaign.maximum_allowed_funds_raised?$scope.campaign.funded_amount>=$scope.campaign.maximum_allowed_funds_raised?($scope.thresholdallowed=!0,$scope.thresholdallowedbtn=!0,$scope.successMessage.push(msg)):($scope.thresholdallowedbtn=!1,$scope.thresholdallowed=!0):($scope.thresholdallowed=!1,$scope.thresholdallowedbtn=!1),$scope.FAQ=success.faqs,success.faqs&&($scope.faqs=success.faqs.length),$scope.campaign.campaign_links=[],success.links&&angular.forEach(success.links,function(value){1==value.region_id&&1==value.resource_content_type_id&&"link"==value.resource_type&&($scope.campaign.video=value.uri.replace(/https?:\/\//gi,$location.protocol()+"://"),VideoLinkService.processVideoLink($scope.campaign.video,""),$scope.campaign.video_type=VideoLinkService.get_video_type(),"custom"==$scope.campaign.video_type&&($scope.campaign.video=VideoLinkService.get_video_link())),2==value.region_id&&$scope.campaign.campaign_links.push(value)}),success.ends&&$scope.dateInPast(success.ends,success.seconds_remaining)&&($scope.disabled=!0),success.description||($scope.noDescription=!0),success.files){var hasMainImage=!1;angular.forEach(success.files,function(value){if(3==value.region_id)return void(hasMainImage=!0)}),hasMainImage||($scope.noMainImage=!0)}else $scope.noMainImage=!0;if($scope.backers_pagination={sort:"-created",page_entries:10,page_limit:100,page:1,pagination:{}},$scope.campaign.backers=[],$scope.getBackers=function(){RestFullResponse.all("campaign/"+success.entry_id+"/backer").getList($scope.backers_pagination).then(function(success){$scope.campaign.backers=success.data;var headers=success.headers();headers["x-pager-total-entries"]?$scope.campaign.backer_offset?$scope.backer_length=parseInt(headers["x-pager-total-entries"])+parseInt($scope.campaign.backer_offset):$scope.backer_length=parseInt(headers["x-pager-total-entries"]):$scope.backer_length="0",$scope.backers_pagination.currentpage=headers["x-pager-current-page"],$scope.backers_pagination.numpages=headers["x-pager-last-page"],$scope.backers_pagination.nextpage=headers["x-pager-next-page"],$scope.backers_pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.backers_pagination.totalentries=headers["x-pager-total-entries"],$scope.backers_pagination.entriesperpage=headers["x-pager-entries-per-page"]})},$scope.getBackers(),$scope.campaign.streams=[],RestFullResponse.all("campaign/"+success.entry_id+"/stream").getList($scope.stream_filter).then(function(success){$scope.campaign.streams=success.data;var headers=success.headers();if($scope.stream_pagination.currentpage=headers["x-pager-current-page"],$scope.stream_pagination.numpages=headers["x-pager-last-page"],$scope.stream_pagination.nextpage=headers["x-pager-next-page"],$scope.stream_pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.stream_pagination.totalentries=headers["x-pager-total-entries"],$scope.stream_pagination.entriesperpage=headers["x-pager-entries-per-page"],$scope.public_settings.site_campaign_updates_display&&$location.search().stream){var stream_id=$location.search().stream;setTimeout(function(){angular.element("#campaign").click(),angular.element("#streams").click();var element=$element.find("#stream-"+stream_id);element[0].scrollIntoView()},0)}}),$scope.checklink=function(){if($location.hash()){$("#campaign").removeClass("active"),$("#campaign-seg").removeClass("active");var hash=$location.hash();"FAQ"==hash?($("#faq").addClass("active"),$("#faq-seg").addClass("active"),$("#default-text").text(hash)):"Backers"==hash?($("#backer").addClass("active"),$("#backer-seg").addClass("active"),$("#default-text").html(hash+'<span class="count-label ui label" >'+$scope.backer_length+"</span>")):"Streams"==hash?($("#stream").addClass("active"),$("#stream-seg").addClass("active"),$("#default-text").html(hash+'<span class="count-label ui label" >'+$scope.campaign.streams.length+"</span>")):"Comments"==hash?($("#comment").addClass("active"),$("#comment-seg").addClass("active"),$("#default-text").html(hash+'<span class="count-label ui label" >'+$scope.sortOrFiltersComments.pagination.totalentries+"</span>")):"Campaign"==hash?($("#campaign").addClass("active"),$("#campaign-seg").addClass("active"),$("#default-text").text(hash)):"Files"==hash&&($("#file").addClass("active"),$("#file-seg").addClass("active"),$("#default-text").text(hash))}},setTimeout(function(){$scope.checklink()},500),$scope.tabactive=function(id){"Campaign"==id&&($("#default-text").text(id),$("#campaign-seg").addClass("active"),$("#backer-seg").removeClass("active"),$("#faq-seg").removeClass("active"),$("#comment-seg").removeClass("active"),$("#stream-seg").removeClass("active")),"FAQ"==id&&($("#default-text").text(id),$("#faq-seg").addClass("active"),$("#campaign-seg").removeClass("active"),$("#backer-seg").removeClass("active"),$("#comment-seg").removeClass("active"),$("#stream-seg").removeClass("active")),"Backers"==id&&($("#default-text").html(id+'<span class="count-label ui label" >'+$scope.backer_length+"</span>"),$("#backer-seg").addClass("active"),$("#faq-seg").removeClass("active"),$("#stream-seg").removeClass("active"),$("#campaign-seg").removeClass("active"),$("#comment-seg").removeClass("active")),"Streams"==id&&($("#default-text").html(id+'<span class="count-label ui label" >'+$scope.campaign.streams.length+"</span>"),$("#stream-seg").addClass("active"),$("#backer-seg").removeClass("active"),$("#faq-seg").removeClass("active"),$("#campaign-seg").removeClass("active"),$("#comment-seg").removeClass("active")),"Comments"==id&&($("#default-text").html(id+'<span class="count-label ui label" >'+$scope.sortOrFiltersComments.pagination.totalentries+"</span>"),$("#comment-seg").addClass("active"),$("#backer-seg").removeClass("active"),$("#faq-seg").removeClass("active"),$("#stream-seg").removeClass("active"),$("#campaign-seg").removeClass("active"))},$rootScope.page_title=$scope.campaign.name?$scope.campaign.name+" - "+$rootScope.site_company:$rootScope.site_company,$rootScope.ogMeta.title=$rootScope.page_title,$scope.campaign.files){for(var max_id=-1,image_index=-1,i=0;i<$scope.campaign.files.length;i++)3===$scope.campaign.files[i].region_id&&$scope.campaign.files[i].id>max_id&&(max_id=$scope.campaign.files[i].id,image_index=i);$rootScope.ogMeta.image=$scope.server+"/image/campaign_detail_large/"+$scope.campaign.files[image_index].path_external}Restangular.one("portal/setting").getList().then(function(success){$scope.public_settings={},$scope.public_settings.site_theme_campaign_display_iso_date=success.site_theme_campaign_display_iso_date,angular.forEach(success,function(value){3==value.setting_type_id&&($scope.public_settings[value.name]=value.value)}),"undefined"!=typeof $scope.public_settings.site_campaign_custom_button&&null!=$scope.public_settings.site_campaign_custom_button||($scope.public_settings.site_campaign_custom_button={toggle:!1,reward:"Choose Reward",contribution:"Contribution"}),$scope.customText=$scope.public_settings.site_campaign_custom_button,$scope.contribution=$scope.customText.contribution;var shortCode="[min]",currency=$filter("formatCurrency")($scope.public_settings.site_theme_campaign_min_contribute_amount,$scope.campaign.currencies[0].code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option);if(1==$scope.customText.toggle){var contributionShortCode=$scope.contribution.indexOf(shortCode)>-1;contributionShortCode&&($scope.contribution=$scope.contribution.replace(shortCode,currency))}$scope.public_settings.site_theme_campaign_min_button_show?$scope.minamount=$scope.public_settings.site_theme_campaign_min_contribute_amount:$scope.minamount=1,"undefined"!=typeof $scope.public_settings.site_theme_campaign_per_min&&$scope.public_settings.site_theme_campaign_per_min&&"undefined"!=typeof $scope.campaign.min_contribution&&($scope.minamount=$scope.campaign.min_contribution),"undefined"!=typeof $scope.public_settings.site_theme_campaign_faq_option?("2"==$scope.public_settings.site_theme_campaign_faq_option&&($scope.hidef=!0,$scope.showFaq=0),"1"==$scope.public_settings.site_theme_campaign_faq_option&&($scope.showFaq=1),"0"==$scope.public_settings.site_theme_campaign_faq_option&&($scope.showFaq=0)):$scope.showFaq=1,null!=$scope.public_settings.site_theme_campaign_backer_option?("2"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.hideb=!0,$scope.showBacker=0),"1"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.showBacker=1,$scope.validUser=1),"0"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.showBacker=0,$scope.validUser=1),"3"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.user.auth_token?($scope.showBacker=1,$scope.validUser=1):($scope.showBacker=0,$scope.validUser=0))):($scope.showBacker=1,$scope.validUser=1),$scope.backer_show=($scope.showBacker||($scope.showBacker||$scope.campaign.backers.length)&&"2"!=$scope.public_settings.site_theme_campaign_backer_option)&&$scope.validUser,null!=$scope.public_settings.site_theme_campaign_comment_option?("2"==$scope.public_settings.site_theme_campaign_comment_option&&($scope.hidec=!0,$scope.showComment=0),"1"==$scope.public_settings.site_theme_campaign_comment_option&&($scope.showComment=1)):$scope.showComment=1,null!=$scope.public_settings.site_theme_campaign_stream_option?("2"==$scope.public_settings.site_theme_campaign_stream_option&&($scope.hides=!0,$scope.showStream=0),"1"==$scope.public_settings.site_theme_campaign_stream_option&&($scope.showStream=1),"0"==$scope.public_settings.site_theme_campaign_stream_option&&($scope.showStream=0)):$scope.showStream=1,$scope.comment_form.anonymous=$scope.public_settings.custom_comment_anonymous_force,"undefined"==typeof $scope.public_settings.site_theme_campaign_hide_min_contribute_message&&($scope.public_settings.site_theme_campaign_hide_min_contribute_message=!1),1==$scope.user.person_id||$scope.user.person_id==$scope.campaign.managers[0].person_id?$scope.validUser=1:$scope.validUser=0},function(failure){$msg={header:failure.data.message},$scope.errorMessage.push($msg)}),$scope.$emit("loading_finished"),1==$location.search().scroll_to_reward&&$scope.scrollToRewards()},function(failure){$location.path("404")})}function check_path(){var params=$location.search();params.stream&&($("#campaign-tabs .ui.menu .item").tab("change tab","streams"),$scope.show_section.streamDetail=!0,Restangular.one("campaign",$scope.campaign_id).one("stream",params.stream).customGET().then(function(success){$scope.stream=success}))}function getNativeName(cityObj){var name="";return null!=cityObj.country_native_name?(name+=cityObj.country_native_name,cityObj.country=cityObj.country_native_name):name+=cityObj.country,null!=cityObj.subcountry_native_name?(name+=" "+cityObj.subcountry_native_name,cityObj.subcountry=cityObj.subcountry_native_name):name+=" "+cityObj.subcountry,null!=cityObj.city_native_name&&"Other"!=cityObj.city?(name+=", "+cityObj.city_native_name,cityObj.city=cityObj.city_native_name):"Other"!=cityObj.city?name+=", "+cityObj.city:cityObj.city="",cityObj.city_full=name,cityObj.name=name,cityObj}function setGACode(gaId){var script="<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','"+gaId+"', 'auto', 'id"+$scope.campaign_id+"');ga('id"+$scope.campaign_id+".send', 'pageview');</script>";$scope.gaScript=$sce.trustAsHtml(script)}$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,$scope.campaign_id=$rootScope.campaignId,$scope.user=UserService,$scope.$location=$location,$rootScope.currentLoc=$location.path(),window.b=$location.path(),$rootScope.campaign_path=$location.path(),$scope.currentAbsUrl=$location.absUrl(),$scope.stream_pagination={},$scope.stream_filter={page_entries:10,page_limit:100,pagination:{},page:1};var msg;$scope.hashcheck=$location.hash();var native_lookup;$scope.show_section={},$scope.show_section.streamDetail=!1,$scope.stream={},$scope.duration="",$scope.dtype="",$("#campaign-tabs .menu-tabs .item").tab({context:$("#campaign-tabs")}),$(".tabular.menu .item").tab(),$(document).ready(function(){window.scrollTo(0,0)}),$scope.showCampaign=0,$scope.showFaq=0,$scope.showBacker=0,$scope.showComment=0,$scope.showStream=0,$scope.isPrivateCampaign=/campaign\/private/.test($rootScope.currentLoc);var guestContribDisabled=!1;PortalSettingsService.getSettingsObj().then(function(success){$scope.public_settings=success.public_setting,$scope.reward_html_editor=success.public_setting.site_theme_campaign_reward_html_editor,native_lookup=success.public_setting.site_theme_shipping_native_lookup,$scope.enabledContribution=success.public_setting.site_campaign_contributions,$scope.enabledContrubitionRewardsPopup=success.public_setting.site_theme_campaign_reward_modal,$scope.contributionInstruction=success.public_setting.site_campaign_contributions_instruction,$scope.removeContactUser=success.public_setting.site_campaign_contact_user,$scope.enableRewardVariation=success.public_setting.site_theme_campaign_show_reward_enable_variation,$scope.isRemoveCampaignFaq=success.public_setting.site_campaign_remove_campaign_faq,$scope.isCreatorNameOnly=success.public_setting.site_campaign_display_creator_info_name_only,$scope.isCreatorInfoOnMainBlock=success.public_setting.site_campaign_creator_info_display,$scope.isBackersOnSidebar=success.public_setting.site_campaign_backers_list_display,$scope.isCommentsOnMainBlock=success.public_setting.site_campaign_comments_display,$scope.isUpdatesOnMainBlock=success.public_setting.site_campaign_updates_display,$scope.isHideBackerProfileLink=success.public_setting.site_campaign_backer_hide_profile_link,$scope.isHideBackedCampaignsAmount=success.public_setting.site_campaign_backer_hide_backed_campaigns,$scope.isBlurbInSidebar=success.public_setting.site_campaign_move_blurb_sidebar,$scope.minContributionAmount=success.public_setting.site_theme_campaign_min_contribute_amount,$scope.isCreatorInfoTopBottomOfCampaign=success.public_setting.site_campaign_creator_info_display_top_bottom,$scope.isExplainerTextEnabled=success.public_setting.site_campaign_enable_explainer_text,$scope.isAllowAnonContactMsg=success.public_setting.site_allow_anonymous_contact_message,$scope.moveEmbedBelowCommentsAccordionMobile=success.public_setting.site_campaign_move_embed_below_comments_accordion,$scope.moveBackersBelowCreatorAccordionMobile=success.public_setting.site_campaign_move_backers_accordion_below_creator_accordion,$scope.pledge_amount=1,$scope.minContributionAmount&&($scope.pledge_amount=$scope.minContributionAmount),"undefined"!=typeof $scope.public_settings.site_campaign_custom_button&&null!=$scope.public_settings.site_campaign_custom_button||($scope.public_settings.site_campaign_custom_button={toggle:!1,reward:"Choose Reward",contribution:"Contribution"}),$scope.customText=$scope.public_settings.site_campaign_custom_button,4==success.public_setting.site_contribute_behaviour["default"]?guestContribDisabled=!0:($scope.cursetting=success,$scope.cursetting.public_setting.site_contribute_behaviour["default"]||($scope.cursetting.public_setting.site_contribute_behaviour["default"]=1),2==$scope.cursetting.public_setting.site_contribute_behaviour["default"]&&(UserService.isLoggedIn()?$scope.user_check=!1:$scope.user_check=!0)),success.public_setting.site_campaign_hide_creator_info&&($scope.site_campaign_hide_creator_info=success.public_setting.site_campaign_hide_creator_info),$scope.comment_form={},$scope.comment_form.message="",null!=success.public_setting.comment_system?$scope.comment_system=success.public_setting.comment_system:$scope.comment_system="disqus","disqus"==$scope.comment_system?DisqusShortnameService.getDisqusShortname().then(function(shortname){var disqus_shortname;angular.forEach(shortname,function(value){3==value.setting_type_id&&(disqus_shortname=value.value)});var disqus_identifier=$scope.campaign_id;$scope.identifier=$scope.campaign_id;var disqus_url=$location.absUrl();if(window.DISQUS)$('<div id="disqus_thread"></div>').insertAfter("#insert_disqus"),DISQUS.reset({reload:!0,config:function(){this.page.identifier=disqus_identifier,this.page.url=disqus_url}});else if(disqus_shortname){$('<div id="disqus_thread"></div>').insertAfter("#insert_disqus"),$scope.disqus_shortname=shortname.value,window.disqus_identifier=disqus_identifier,window.disqus_url=disqus_url;var dsq=document.createElement("script");dsq.type="text/javascript",dsq.async=!0,dsq.src="//"+disqus_shortname+".disqus.com/embed.js",$("head").append(dsq)}}):"custom"==$scope.comment_system&&($scope.comments_show_comment_picture=success.public_setting.custom_comment_show_comment_picture,$scope.getComments(),$scope.comments_background_style={"background-color":"#"+success.public_setting.custom_comment_comment_background_color,"font-family":success.public_setting.custom_comment_font_family},$scope.comments_font_color={color:"#"+success.public_setting.custom_comment_font_color},success.public_setting.custom_comment_auto_refresh&&setInterval(function(){$scope.getComments()},6e4)),getCampaign()}),$scope.scrollToRewards=function(){$timeout(function(){$("html, body").animate({scrollTop:$("#rewards-list").offset().top-15},500)},1e3)},"undefined"!=typeof $scope.public_settings.site_campaign_goog_shortener&&null!=!$scope.public_settings.site_campaign_goog_shortener||($scope.public_settings.site_campaign_goog_shortener={toggle:!1,code:""}),void 0!==typeof $scope.public_settings.site_campaign_goog_shortener&&$scope.public_settings.site_campaign_goog_shortener.toggle?$http({method:"POST",url:"https://www.googleapis.com/urlshortener/v1/url?key="+$scope.public_settings.site_campaign_goog_shortener.code,data:'{"longUrl": "'+$location.absUrl()+'"}'}).then(function(response){$scope.shortenedUrl=response.data.id}):$scope.shortenedUrl=$location.absUrl();var comment_error_msg=$translate.instant("custom_commment_form_error_msg");switch(setTimeout(function(){$("#comment-form").form({comment_message:{identifier:"comment_message",rules:[{type:"empty",prompt:comment_error_msg}]}},{inline:!0,onSuccess:function(event){event.preventDefault()}})}),$scope.public_settings.custom_comment_anonymous_commenting){case ANONYMOUS_COMMENT.anonymous_disabled:$scope.is_anonymous_available=!1;break;case ANONYMOUS_COMMENT.anonymous_backers:$scope.is_anonymous_available=!1;var backerFilters={person_id:$scope.user.id};Restangular.one("campaign",$scope.campaign_id).customGET("backer?filters="+JSON.stringify(backerFilters)).then(function(success){var successArr=success.plain();null!=successArr&&successArr.length>0&&($scope.is_anonymous_available=!0)});break;case ANONYMOUS_COMMENT.anonymous_users:$scope.is_anonymous_available=!0;break;default:$scope.is_anonymous_available=!1}$scope.addComment=function(comment_form){comment_form.message&&($scope.sendComment={},comment_form.comment_title&&($scope.sendComment.title=comment_form.comment_title),$scope.sendComment.entry_id=$scope.campaign_id,$scope.sendComment.message=comment_form.message,$scope.sendComment.anonymous=comment_form.anonymous,Restangular.one("campaign/"+$scope.campaign_id+"/comment").customPOST($scope.sendComment).then(function(success){$scope.getComments(),$scope.comment_form={anonymous:$scope.public_settings.custom_comment_anonymous_force}}))},$scope.deleteComment=function(comment_id){Restangular.one("campaign/"+$scope.campaign_id+"/comment/"+comment_id).customDELETE().then(function(){$scope.getComments()})},$scope.updateComment=function(comment_form){$scope.changeComment={},comment_form.title&&($scope.changeComment.title=comment_form.title),$scope.changeComment.entry_id=$scope.campaign_id,$scope.changeComment.message=comment_form.message,$scope.changeComment.comment_id=comment_form.comment_id,Restangular.one("campaign/"+$scope.campaign_id+"/comment/"+comment_form.comment_id).customPUT($scope.changeComment).then(function(success){$scope.getComments()})},$scope.setUpVote=function(isAnonymous){isAnonymous?($scope.comment_action.anonymous=!0,setVote()):setVote()},$scope.commentAction=function(comment_action,comment_id){$scope.user.person_id&&($scope.comment_action={},"upvote"==comment_action?($scope.comment_action.entry_id=$scope.campaign_id,$scope.comment_action.comment_action_type_id=1,$scope.comment_action.comment_id=comment_id,$scope.is_anonymous_available?$timeout(function(){$("#vote-anonymous").modal("show")}):($scope.comment_action.anonymous=!1,setVote())):"downvote"==comment_action?($scope.comment_action.entry_id=$scope.campaign_id,$scope.comment_action.comment_action_type_id=2,$scope.comment_action.comment_id=comment_id,$scope.is_anonymous_available?$timeout(function(){$("#vote-anonymous").modal("show")}):($scope.comment_action.anonymous=!1,setVote())):"reply"==comment_action&&($scope.comment_form.message+="'@"+comment_id+"' \n",$location.hash("comment-form"),$anchorScroll(),document.getElementById("custom_comment_message").focus()))},$scope.sortOrFiltersComments={sort:"-created",page_entries:5,page_limit:100,page:1,pagination:{}},$scope.getComments=function(comment_id,sort_order){if(sort_order&&($scope.sortOrFiltersComments.sort=sort_order),comment_id){var req=Restangular.one("campaign/"+$scope.campaign_id+"/comment/"+comment_id).customGET();return req}RestFullResponse.one("campaign/"+$scope.campaign_id).customGET("comment",$scope.sortOrFiltersComments).then(function(success){$scope.comments=success.data;var headers=success.headers();$scope.sortOrFiltersComments.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersComments.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersComments.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersComments.pagination.pagesinset=headers["x-pager-pages-in-set"],headers["x-pager-total-entries"]?$scope.sortOrFiltersComments.pagination.totalentries=headers["x-pager-total-entries"]:$scope.sortOrFiltersComments.pagination.totalentries=0,$scope.sortOrFiltersComments.pagination.entriesperpage=headers["x-pager-entries-per-page"]})},$scope.openModalById=function(id,comment_id){if("update-comment"==id){var old_comment=$scope.getComments(comment_id);old_comment.then(function(success){$scope.old_comment=success.plain(),$(".ui.modal#"+id).modal("show")})}else $scope.current_selected_comment_id=comment_id,$(".ui.modal#"+id).modal("show")},$scope.moment=function(value,suffix){return moment(value).fromNow(suffix)},$scope.daysEndDateInPast=function(daysEnd,ends,seconds_remaining){return 1!=daysEnd&&(!(!seconds_remaining||!ends)&&!$scope.dateInPast(ends,seconds_remaining))},$scope.dateInPast=function(value,sec){return 0==sec||"00"==sec||sec<0},$scope.rewardExpired=function(value){if(value){var temp=value.split(" "),firstPart=temp[0].replace(/-/g,"/"),rewardDateVal=firstPart+" "+temp[1],today_date=(new Date).toDateString(),reward_date=new Date(rewardDateVal).toDateString();return reward_date==today_date}return!1},$scope.filterRewards=function(){var startindex=($scope.rewardPagination.page-1)*$scope.rewardPagination.page_entries,endindex=startindex+$scope.rewardPagination.page_entries;$scope.campaign.pledges_to_show=angular.copy($scope.campaign.pledges),$scope.campaign.pledges_to_show=$scope.campaign.pledges_to_show.slice(startindex,endindex),$scope.customText.toggle&&angular.forEach($scope.campaign.pledges_to_show,function(value,key,obj){obj[key].rewardCustom=$scope.customText.reward;var currency=$filter("formatCurrency")(obj[key].amount,$scope.campaign.currencies[0].code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option),rewardCode="[reward]";if(1==$scope.customText.toggle){var rewardShortCode=obj[key].rewardCustom.indexOf(rewardCode)>-1;rewardShortCode&&(obj[key].rewardCustom=obj[key].rewardCustom.replace(rewardCode,currency))}})},$scope.absurl=$location.absUrl(),$scope.pledgeModal=function(pledge){$("#pledge-modal").modal("show"),$scope.oAmount=pledge.amount,$scope.pledgeAmount=pledge.amount,$scope.pledgeDescription=pledge.description,
$scope.pledgeName=pledge.name,$scope.pledgeLevel=pledge.pledge_level_id},$scope.amountNextLevel=!1,$scope.visitProfile=function(index){$scope.isHideBackerProfileLink||($scope.campaign.backers,$window.open("profile/"+$scope.campaign.backers[index].person_id))},$scope.makeLink=function(id){var linkpath=$location.path();$location.path(linkpath).hash(id).replace(),$scope.hashcheck=$location.hash()},$scope.showManager=function(){$window.open("profile/"+$scope.campaign.managers[0].person_id)},$scope.getTotalStream=function(){var tmp=parseInt($scope.stream_pagination.entriesperpage)*parseInt($scope.stream_filter.page_limit);return tmp>$scope.stream_pagination.totalentries?$scope.stream_pagination.totalentries:tmp},$scope.toDate=function(str){if(str&&str.length){var d=str.substring(0,10),lst=str.substring(0,10).split("-"),time=str.substring(11,16);new Date(lst[0],lst[1]-1,lst[2]);return d+"  "+time}},$scope.showStreamDeail=function(stream,index){$scope.stream=stream,$scope.stream.sindex=index,$location.search("stream",stream.id).replace()},check_path(),$scope.submitPledge=function(pledge,index){$location.search({});var rewardAttr=[];$("#reward-variation-"+index).find('input[name="variation_value"]').each(function(){rewardAttr.push($(this).val())}),$(".pledge-level .ng-isolate-scope a:hover").length||($scope.enabledContribution?UserService.isLoggedIn()||guestContribDisabled?($location.path("/pledge-campaign").search("eid",$rootScope.campaignId).search("plid",pledge.pledge_level_id).search("m",pledge.amount).search("m",pledge.amount).search("attr",rewardAttr),/campaign\/private/.test($rootScope.currentLoc)&&$location.search("privatepath",$rootScope.currentLoc.substring(1))):($location.path("/inline-contribution").search("eid",$rootScope.campaignId).search("plid",pledge.pledge_level_id).search("m",pledge.amount).search("attr",rewardAttr),/campaign\/private/.test($rootScope.currentLoc)&&$location.search("privatepath",$rootScope.currentLoc.substring(1))):$(".ui.modal.contribution-instruction").modal("show"))},$scope.submitContribute=function(){$scope.enabledContribution?UserService.isLoggedIn()||guestContribDisabled?($location.path("/pledge-campaign").search("m",$scope.pledge_amount).search("eid",$scope.campaign_id),/campaign\/private/.test($rootScope.currentLoc)&&$location.search("privatepath",$rootScope.currentLoc.substring(1))):($location.path("/inline-contribution").search("m",$scope.pledge_amount).search("eid",$scope.campaign_id),/campaign\/private/.test($rootScope.currentLoc)&&$location.search("privatepath",$rootScope.currentLoc.substring(1))):UserService.isLoggedIn()?$(".ui.modal.contribution-instruction").modal("show"):$location.path("/login")},$scope.miniContributeReward=function(){$scope.enabledContribution?$scope.enabledContrubitionRewardsPopup?$(".ui.modal.rewards-popup-modal").modal("show"):UserService.isLoggedIn()||guestContribDisabled?($location.path("/pledge-campaign").search("m",$scope.pledge_amount).search("eid",$scope.campaign_id),/campaign\/private/.test($rootScope.currentLoc)&&$location.search("privatepath",$rootScope.currentLoc.substring(1))):($location.path("/inline-contribution").search("m",$scope.pledge_amount).search("eid",$scope.campaign_id),/campaign\/private/.test($rootScope.currentLoc)&&$location.search("privatepath",$rootScope.currentLoc.substring(1))):UserService.isLoggedIn()?$(".ui.modal.contribution-instruction").modal("show"):$location.path("/login")},$scope.$on("$locationChangeSuccess",function(event){!$location.hash()}),$scope.$on("$routeChangeStart",function(event,next,current){window.hasOwnProperty("ga")&&ga.remove("id"+$scope.campaign_id+".remove")}),$scope.receiver={},$scope.message={first_name:"",last_name:"",email:""},$scope.user_list_page=1,$scope.user_list_page_entries=10;var msg;$scope.isLoggedin=UserService.isLoggedIn(),$scope.showContactModal=function(user){user&&($scope.receiver=user),UserService.isLoggedIn()||$scope.isAllowAnonContactMsg?user?($(".contact-message-modal").modal("is active")&&($(".ui modal").modal("hide all"),$(".ui dimmer").dimmer("hide")),$(".contact-message-modal").modal("show"),$(".contact-message-modal").modal("setting",{onApprove:$scope.sendContactMessage})):($(".contact-user-modal").modal("is active")&&($(".ui modal").modal("hide all"),$(".ui dimmer").dimmer("hide")),$(".contact-user-modal").modal("show"),$(".contact-user-modal").modal("setting",{onApprove:$scope.sendUserMessage})):$(".log-in-required-modal").modal("show")},$scope.validateMessage=function(form_target){var translation=$translate.instant(["contact_message_missing_subject","contact_message_missing_body","contact_message_missing_recipient","contact_message_missing_first_name","contact_message_missing_last_name","contact_message_missing_email","contact_email_validate_error"]),fields={subject:{identifier:"subject",rules:[{type:"empty",prompt:translation.contact_message_missing_subject}]},body:{identifier:"body",rules:[{type:"empty",prompt:translation.contact_message_missing_body}]},recipient:{identifier:"recipient",rules:[{type:"empty",prompt:translation.contact_message_missing_recipient}]},first_name:{identifier:"first_name",rules:[{type:"empty",prompt:translation.contact_message_missing_first_name}]},last_name:{identifier:"last_name",rules:[{type:"empty",prompt:translation.contact_message_missing_last_name}]},email:{identifier:"email",rules:[{type:"empty",prompt:translation.contact_message_missing_email},{type:"email",prompt:translation.contact_email_validate_error}]}};"contact-message"==form_target&&$(".ui.form.contact-message").form(fields,{inline:!0,onSuccess:function(){$scope.validMessage=!0},onFailure:function(){$scope.validMessage=!1}}).form("validate form"),"contact-user"==form_target&&$(".ui.form.contact-user").form(fields,{inline:!0,onSuccess:function(){$scope.validMessage=!0},onFailure:function(){$scope.validMessage=!1}}).form("validate form")},$scope.sendContactMessage=function(){return $scope.validateMessage("contact-message"),!!$scope.validMessage&&($scope.message.body=$scope.message.body.replace(/(\r\n|\n|\r)/gm,"<br>"),$scope.message.person_id=$scope.receiver.id,msg={loading_message:"action_sending",loading:!0},$rootScope.floatingMessage=msg,Restangular.one("account/message").customPOST($scope.message).then(function(success){$translate("message_sentto").then(function(value){msg={header:value+" "+$scope.receiver.first_name+" "+$scope.receiver.last_name},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),$scope.cleartext()},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),$(".contact-message-modal").modal("hide"),void 0)},$scope.sendUserMessage=function(){if($scope.validateMessage("contact-user"),!$scope.validMessage)return!1;var data={body:$scope.message.body.replace(/(\r\n|\n|\r)/gm,"<br>"),person_id:$scope.receiver.id,subject:$scope.message.subject};msg={loading_message:"action_sending",loading:!0},$rootScope.floatingMessage=msg,Restangular.one("account/message").customPOST(data).then(function(success){$translate("message_sentto").then(function(value){msg={header:value+" "+$scope.receiver.first_name+" "+$scope.receiver.last_name},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),$scope.cleartext(),$scope.$emit("composed_new_message")},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),$(".contact-user-modal").modal("hide")},$scope.setRecipient=function(event){var first_name=event.target.attributes["first-name"].value,last_name=event.target.attributes["last-name"].value,id=event.target.attributes["data-value"].value;$scope.receiver.id=id,$scope.receiver.first_name=first_name,$scope.receiver.last_name=last_name},$scope.setRecipientOnEnter=function(event){if(13==event.keyCode){var updatedRecipient=angular.element("div.to-user a.profile-link"),first_name=updatedRecipient[0].attributes["first-name"].value,last_name=updatedRecipient[0].attributes["last-name"].value,id=updatedRecipient[0].attributes["user-id"].value;$scope.receiver.id=id,$scope.receiver.first_name=first_name,$scope.receiver.last_name=last_name}},$scope.updateUserList=function(name){$scope.user_list_page=1,$scope.getPeopleNames(name)},$scope.getPeopleNames=function(name,append){$scope.append=!1,void 0!==append&&($scope.append=append);var filters={filters:{name:name},page:$scope.user_list_page,page_entries:$scope.user_list_page_entries};RestFullResponse.all("portal/person-public").getList(filters).then(function(success){$scope.pagination_info=success.headers(),$scope.append||($scope.list_users=[]);for(var i in success.data)void 0!==success.data[i]&&null!==success.data[i]&&"object"==typeof success.data[i]&&"id"in success.data[i]&&$scope.list_users.push(success.data[i]);$timeout(function(){$scope.list_users.length>0&&$(".recipient.dropdown").dropdown("show")},0)},function(failed){$scope.list_users=!1})};var pageAdjust=function(adjust){$scope.user_list_page+adjust>0&&($scope.user_list_page+=adjust)};$scope.appendNextPage=function(){$scope.user_list_page>=$scope.pagination_info["x-pager-last-page"]||(pageAdjust(1),$scope.getPeopleNames($scope.message.receiver,!0))},$scope.nextPage=function(){pageAdjust(1),$scope.getPeopleNames($scope.message.receiver)},$scope.previousPage=function(){pageAdjust(-1),$scope.getPeopleNames($scope.message.receiver)},$scope.cleartext=function(){$("#subject").val(""),$("#message").val(""),$("#subject-user").val(""),$("#message-user").val(""),void 0!==$scope.message&&("subject"in $scope.message&&($scope.message.subject=""),"body"in $scope.message&&($scope.message.body=""),"first_name"in $scope.message&&($scope.message.first_name=""),"last_name"in $scope.message&&($scope.message.last_name=""),"email"in $scope.message&&($scope.message.email=""))},$scope.getPeopleNames("")}]);