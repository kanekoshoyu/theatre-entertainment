app.controller("PledgeHistoryCtrl",["$routeParams","$location","$timeout","$translatePartialLoader","$translate","$scope","$rootScope","RestFullResponse","UserService","Restangular","RESOURCE_REGIONS","RequestCacheService","PortalSettingsService",function($routeParams,$location,$timeout,$translatePartialLoader,$translate,$scope,$rootScope,RestFullResponse,UserService,Restangular,RESOURCE_REGIONS,RequestCacheService,PortalSettingsService){function filterCampaign(filter){RestFullResponse.all("campaign").getList(filter).then(function(success){updateURL(),$scope.campaigns=success.data.plain(),angular.forEach($scope.campaigns,function(campaignValue){Restangular.one("campaign",campaignValue.id).one("pledge").customGET().then(function(pledge){campaignValue.pledge_details=pledge.plain()}),angular.forEach(campaignValue.files,function(fileValue,index){"Campaign Thumbnail"==fileValue.region_name&&fileValue.path_external&&(campaignValue.campaign_thumb_url=fileValue.path_external)})});var headers=success.headers();$scope.sortOrFiltersCampaign.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersCampaign.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersCampaign.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersCampaign.pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.sortOrFiltersCampaign.pagination.totalentries=headers["x-pager-total-entries"],$scope.sortOrFiltersCampaign.pagination.entriesperpage=headers["x-pager-entries-per-page"]})}function updateURL(){var firstpage=1==$routeParams.page||1==$scope.sortOrFiltersCampaign.page,pageparam=firstpage?null:$scope.sortOrFiltersCampaign.page;"object"==typeof $scope.sortOrFiltersCampaign.filters.category?$location.search("category",null):$location.search("category",$scope.sortOrFiltersCampaign.filters.category),$location.search("name",$scope.sortOrFiltersCampaign.filters.name||null),$location.search("page",pageparam)}function processParams(){$scope.sortOrFiltersCampaign.filters.category=$routeParams.category||$scope.sortOrFiltersCampaign.filters.category,$scope.sortOrFiltersCampaign.filters.entry_status_id=$routeParams.status||$scope.sortOrFiltersCampaign.filters.entry_status_id,$scope.sortOrFiltersCampaign.filters.name=$routeParams.name||$scope.sortOrFiltersCampaign.filters.name,$scope.sortOrFiltersCampaign.page=$routeParams.page||1}$scope.RESOURCE_REGIONS=RESOURCE_REGIONS;var user=UserService;$scope.toggle={},$scope.sortOrFiltersCampaign={sort:"",filters:{category:{},entry_status_id:[],backer:user.person_id},page_entries:10,page_limit:100,pagination:{},page:1},$scope.totalentry=[10,25,40,55,70];var today_date=new Date,offset=today_date.getTimezoneOffset();today_date.setMinutes(today_date.getMinutes()-offset),$scope.today=today_date.toISOString().substring(0,19).replace("T"," "),$scope.campaign_status=["tab_pledge_filter_all","tab_pledge_filter_campaign_running","tab_pledge_filter_campaign_ended"],processParams(),filterCampaign($scope.sortOrFiltersCampaign);var msg;PortalSettingsService.getSettingsObj().then(function(success){$scope.portalsetting=success,$scope.isISODate=success.public_setting.site_theme_campaign_display_iso_date,"undefined"==typeof success.public_setting.site_campaign_pledge_update&&(success.public_setting.site_campaign_pledge_update=!1),"undefined"==typeof success.public_setting.site_campaign_withdraw_hide&&(success.public_setting.site_campaign_withdraw_hide=!1),$scope.campaignWithdrawContribution=success.public_setting.site_campaign_withdraw_hide,$scope.campaignPledgeReplace=success.public_setting.site_campaign_pledge_update}),RequestCacheService.getCategory().then(function(success){$scope.categories=success,$rootScope.checkpledgehistory=$scope.categories}),Restangular.one("campaign").all("status").getList().then(function(success){$scope.campaignStatus=success}),$scope.searchCampaign=function(word){$scope.sortOrFiltersCampaign.filters.name=word,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignCategory=function(category){$scope.sortOrFiltersCampaign.filters.category=category,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignStatus=function(status){$scope.sortOrFiltersCampaign.filters.entry_status_id=status.id,filterCampaign($scope.sortOrFiltersCampaign)},$scope.checkentry=function(){$scope.entries=$("#searchbtn").dropdown("get value"),$scope.sortOrFiltersCampaign.page_entries=$scope.entries,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignOrder=function(order){$scope.sortOrFiltersCampaign.sort=order,filterCampaign($scope.sortOrFiltersCampaign)},$scope.selectStatus=function(index){0==index?$scope.sortOrFiltersCampaign.filters.entry_status_id="":1==index?$scope.sortOrFiltersCampaign.filters.entry_status_id=[1,2,4]:2==index&&($scope.sortOrFiltersCampaign.filters.entry_status_id=[5,6,7,8,9]),filterCampaign($scope.sortOrFiltersCampaign)},$scope.openPledgeDetail=function(parent,index,campaignIndex){[5,6,7,8,9,13].indexOf(parent.campaign.entry_status_id)>-1?$scope.hideWithdraw=!0:$scope.hideWithdraw=!1,$scope.parentIndex=parent.$index,$scope.pledgeDetails=parent.$parent.campaign,$scope.detailIndex=index,$("#pledge-details").modal("show"),$scope.currentCampaign={currency:$scope.campaigns[campaignIndex].currencies[0],id:$scope.campaigns[campaignIndex].id,pledge:$scope.campaigns[campaignIndex].pledges,pledgeDetailId:$scope.campaigns[campaignIndex].pledge_details[index].id,amount:$scope.campaigns[campaignIndex].pledge_details[index].amount},Restangular.one("campaign",$scope.currentCampaign.id).customGET().then(function(success){$scope.currentCampaign.pledge=success.pledges}),null!==$scope.currentCampaign.pledge?$scope.isThereRewards=!0:$scope.isThereRewards=!1},$scope.openModalById=function(id){$(".ui.modal#"+id).modal("show")},$scope.deletePledge=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("campaign",$scope.pledgeDetails.id).one("pledge",$scope.pledgeDetails.pledge_details[$scope.detailIndex].id).customDELETE().then(function(success){msg={header:"action_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})},$scope.sortByDate=function(){$scope.toggle.created=!$scope.toggle.created,$scope.toggle.created?$scope.sortOrFiltersCampaign.sort="created":$scope.sortOrFiltersCampaign.sort="-created",filterCampaign($scope.sortOrFiltersCampaign)},$scope.filterCampaign=function(){filterCampaign($scope.sortOrFiltersCampaign)},$scope.$emit("loading_finished"),$scope.getPledges=function(campaignID){Restangular.one("campaign",campaignID).one("pledge").customGET().then(function(pledges){$scope.pledge_histories=pledges})},$scope.replaceContribution=function(){$("#replace-contribution-modal").modal("show")},$scope.rewardSelected=function(data){$scope.currentReward=$scope.currentCampaign.pledge[data],$scope.rewardAttr=""},$scope.amountModalView=function(){$scope.isAmountContribution=!0},$scope.rewardsModalView=function(){$scope.currentCampaign.pledge.length&&$scope.rewardSelected(0),$scope.isRewardsContribution=!0},$scope.replacementClose=function(){$("#replace-contribution-modal").modal("hide"),$scope.isRewardsContribution=!1,$scope.isAmountContribution=!1,$scope.currentReward=null,$scope.contributionValue=null},$scope.amountValidation=function(replaceAmount){if($scope.portalsetting.public_setting.site_campaign_pledge_update){$scope.value=null!=$scope.value?document.getElementById("amountContributed").value:0,$scope.isValidAmount=$scope.value>$scope.currentCampaign.amount;var isNumber=/^\d+$/.test($scope.value);return $scope.isValidAmount&&isNumber?(document.getElementById("replacementButton").disabled=!1,$("#replacementButton").addClass("active"),$("#replacementButton").removeClass("disabled")):(document.getElementById("replacementButton").disabled=!0,$("#replacementButton").removeClass("active"),$("#replacementButton").addClass("disabled")),$scope.isValidAmount}return!0},$scope.rewardValidation=function(currentReward,replaceAmount){if($scope.portalsetting.public_setting.site_campaign_pledge_update){var reward_amount=$scope.currentReward?$scope.currentReward.amount:0;$scope.isValidAmount=reward_amount>$scope.currentCampaign.amount;var isNumber=/^\d+$/.test(reward_amount);return $scope.isValidAmount&&isNumber?(document.getElementById("replacementButton").disabled=!1,$("#replacementButton").addClass("active"),$("#replacementButton").removeClass("disabled")):(document.getElementById("replacementButton").disabled=!0,$("#replacementButton").removeClass("active"),$("#replacementButton").addClass("disabled")),$scope.isValidAmount}return!0},$scope.submitReplacement=function(){var rewardAttr=[];return $("#reward-variation").find('input[name="variation_value"]').each(function(){rewardAttr.push($(this).val())}),$scope.contributionValue=null!=$scope.contributionValue?$scope.submitReplacement.amount:0,$scope.contributionValue>0?void $location.path("/pledge-campaign").search("eid",$scope.currentCampaign.id).search("m",$scope.contributionValue).search("r",$scope.currentCampaign.pledgeDetailId):$scope.currentReward?void $location.path("/pledge-campaign").search("eid",$scope.currentCampaign.id).search("plid",$scope.currentReward.pledge_level_id).search("m",$scope.currentReward.amount).search("attr",rewardAttr).search("r",$scope.currentCampaign.pledgeDetailId):void 0}}]);