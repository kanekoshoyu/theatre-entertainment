app.controller("CompleteFundingCtrl",["$translate","CampaignSettingsService","$routeParams","$scope","$rootScope","$timeout","Restangular","CreateCampaignService","$location","StripeService","UserService","PortalSettingsService",function($translate,CampaignSettingsService,$routeParams,$scope,$rootScope,$timeout,Restangular,CreateCampaignService,$location,StripeService,UserService,PortalSettingsService){function fundingValidation(){var translation=$translate.instant(["complete_funding_bank_errormessage"]);$(".startfunding-form.ui.form").form({stripe_account:{identifier:"stripe_account",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}$scope.clearMessage=function(){$rootScope.floatingMessage=[]};var msg=[];$scope.campaign={},$scope.campaignID=$routeParams.campaign_id,$scope.nextStepUrl="campaign-preview/"+$routeParams.campaign_id,$scope.backUrl="profile-setup/"+$routeParams.campaign_id,$scope.saddress={street:"",mail:"",city:"",country:""},$scope.clientID=null,StripeService.clientID().then(function(success){success&&($scope.clientID=success)}),$scope.user=UserService,$scope.useremail=$scope.user.email,PortalSettingsService.getSettingsObj().then(function(success){$scope.$emit("loading_finished"),$scope.portalsetting=success.public_setting,$scope.direct_transaction=success.public_setting.site_campaign_fee_direct_transaction,$scope.reward_show=success.public_setting.site_theme_campaign_show_reward_section,"undefined"!=typeof $scope.portalsetting.site_campaign_hide_profile&&null!==$scope.portalsetting.site_campaign_hide_profile||($scope.portalsetting.site_campaign_hide_profile=!1),$scope.showProfile=!$scope.portalsetting.site_campaign_hide_profile,$scope.showProfile?!$scope.showProfile&&$scope.reward_show?$scope.backUrl="campaign-setup/"+$routeParams.campaign_id:$scope.backUrl="profile-setup/"+$routeParams.campaign_id:$scope.backUrl="rewards/"+$routeParams.campaign_id,$scope.showProfile||$scope.reward_show||($scope.backUrl="campaign-setup/"+$routeParams.campaign_id),$scope.portalsetting.site_enable_advanced_widget&&($scope.nextStepUrl="campaign-widget/"+$routeParams.campaign_id),$scope.portalsetting.site_campaign_country_funding_step&&($scope.bank={}),$scope.direct_transaction&&1!==UserService.person_type_id&&$location.path("/404")}),CreateCampaignService.load($routeParams.campaign_id).then(function(success){$scope.campaign=success,CampaignSettingsService.setCampaignId($routeParams.campaign_id),CampaignSettingsService.processSettings(success.settings),$scope.campaign.settings=CampaignSettingsService.getSettings(),$scope.campaign.settings.bank&&($scope.bank=$scope.campaign.settings.bank),$scope.campaigndesc=$scope.name+" -"+$scope.campaign.blurb,Restangular.one("account/business").customGET().then(function(success){$scope.companies=success,"undefined"==typeof $scope.portalsetting.site_theme_portal_company_name||"undefined"==typeof $scope.portalsetting.site_theme_portal_company_number?$scope.companies.length>0?$scope.campaignName=$scope.companies[0].name:($scope.campaignName=$scope.campaign.name,$scope.number="xxxxxxxxxx"):($scope.campaignName=$scope.portalsetting.site_theme_portal_company_name,$scope.number=$scope.portalsetting.site_theme_portal_company_number)})}),$scope.website=$location.protocol()+"://"+$location.host()+"/campaign/"+$scope.campaignID,Restangular.one("account/address").customGET().then(function(success){$scope.address=success,$scope.address.business&&$scope.address.business.length>0?$scope.paddress=$scope.address.business:$scope.paddress=$scope.address.personal,$scope.paddress&&($scope.saddress={street:$scope.paddress[0].street1,mail:$scope.paddress[0].mail_code,city:$scope.paddress[0].city,country:$scope.paddress[0].code_iso3166_1})}),$scope.bankValidation=function(){var translation=$translate.instant(["complete_funding_bank_errormessage","complete_funding_bank_account_confirm_errormessage"]);$(".startfunding-form.ui.form").form({bank_beneficiary:{identifier:"bank_beneficiary",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_cpf:{identifier:"bank_cpf",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_code:{identifier:"bank_code",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_name:{identifier:"bank_name",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_branch:{identifier:"bank_branch",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_account:{identifier:"bank_account",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_account_confirm:{identifier:"bank_account_confirm",rules:[{type:"match[bank_account]",prompt:translation.complete_funding_bank_account_confirm_errormessage}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.saveData=function($event){$scope.valcheck=!0,$scope.portalsetting.site_campaign_country_funding_step?$scope.bankValidation():fundingValidation(),$(".field").hasClass("error")&&$("html, body").animate({scrollTop:$(".field.error").offset().top+15},"fast");var currentEle=$event.currentTarget;!$(currentEle).hasClass("save-campaign-button");if(!$scope.valcheck)return $event.preventDefault(),msg={header:"fail_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),!1;if(msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$scope.portalsetting.site_campaign_country_funding_step&&$scope.campaign.settings.country_bank_form){$scope.campaign.settings.bank=$scope.bank;var data={force_direct_transaction:1};Restangular.one("campaign",$scope.campaignID).customPUT(data).then(function(success){CampaignSettingsService.saveSettings($scope.campaign.settings),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})}else{var data={stripe_account_id:$scope.campaign.stripe_account_id};Restangular.one("campaign",$scope.campaignID).customPUT(data).then(function(success){CampaignSettingsService.saveSettings($scope.campaign.settings),CreateCampaignService.cacheIn(success.plain()),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})}},$scope.selectStripeId=function(id){$scope.campaign.stripe_account_id=id},CreateCampaignService.load($routeParams.campaign_id).then(function(success){$scope.campaign=success,$scope.campaign.settings=CampaignSettingsService.getSettings(),Restangular.one("campaign",$routeParams.campaign_id).one("stripe-account").customGET().then(function(success){var stripe_accounts=success.plain();UserService.id==$scope.campaign.managers[0].id?StripeService.getAccount().then(function(success){success.length&&($scope.stripeAccounts=success,$scope.stripeConnected=!0,!stripe_accounts.length&&$scope.stripeAccounts.length?$scope.campaign.stripe_account_id=$scope.stripeAccounts[0].id:stripe_accounts.length&&($scope.campaign.stripe_account_id=stripe_accounts[0].id),$rootScope.isConnectWithStripe&&$timeout(function(){$("button.save-campaign-button").click()},100))}):($scope.stripeAccounts=stripe_accounts,stripe_accounts.length&&($scope.stripeConnected=!0,$scope.campaign.stripe_account_id=stripe_accounts[0].id,$rootScope.isConnectWithStripe&&$timeout(function(){$("button.save-campaign-button").click()},100)))})}),Restangular.one("account/phone-number").customGET().then(function(success){success.business?$scope.number=success.business[0].number:success.personal&&($scope.number=success.personal[0].number)}),$scope.stateParam=StripeService.generateStateParam("/complete-funding/"+$scope.campaignID),$scope.stripeRedirect=StripeService.redirectURL(),$scope.setRedirectUrl=function(){var baseUrl="https://connect.stripe.com/oauth/authorize?",params={response_type:"code",client_id:$scope.clientID.client_id,account:$scope.clientID.client_id,stripe_user:{product_description:$scope.campaigndesc,business_name:$scope.campaignName,first_name:$scope.user.first_name,last_name:$scope.user.last_name,country:$scope.saddress.country,phone_number:$scope.number,url:$scope.website,email:$scope.useremail,street_address:$scope.saddress.street,city:$scope.saddress.city,zip:$scope.saddress.mail},scope:"read_write",redirect_uri:$scope.stripeRedirect,state:$scope.stateParam},finalUrl=baseUrl+$.param(params);window.location.href=finalUrl}}]);