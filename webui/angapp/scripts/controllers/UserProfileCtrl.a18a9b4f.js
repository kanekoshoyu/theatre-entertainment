app.controller("UserProfileCtrl",["$q","$routeParams","$rootScope","$location","$scope","$timeout","$translate","Geolocator","UserService","Restangular","CreateCampaignService","FileUploadService","PortalSettingsService","PHONE_TYPE",function($q,$routeParams,$rootScope,$location,$scope,$timeout,$translate,Geolocator,UserService,Restangular,CreateCampaignService,FileUploadService,PortalSettingsService,PHONE_TYPE){function prevent_default_enter_key($event){if(13==$event.keyCode)return!1}function toggleProfileTypeViewText(){var profile_type_text_translation=$translate.instant(["profile_setup_toggle_view_on_campaign_both_text","profile_setup_toggle_view_on_campaign_user_text","profile_setup_toggle_view_on_campaign_business_text"]);$scope.campaign.toggle_profile_type_view_advance?0==$scope.campaign.profile_type_view_id?$scope.profile_type_view_text=profile_type_text_translation.profile_setup_toggle_view_on_campaign_both_text:1==$scope.campaign.profile_type_view_id?$scope.profile_type_view_text=profile_type_text_translation.profile_setup_toggle_view_on_campaign_business_text:$scope.profile_type_view_text=profile_type_text_translation.profile_setup_toggle_view_on_campaign_user_text:$scope.campaign.business_organizations?$scope.profile_type_view_text=profile_type_text_translation.profile_setup_toggle_view_on_campaign_both_text:$scope.profile_type_view_text=profile_type_text_translation.profile_setup_toggle_view_on_campaign_user_text}function getCompany(){Restangular.one("account/").customGET("business",paramID).then(function(success){$scope.companies=success,0!=$scope.companies?$scope.companyFormToggle=!0:$scope.companyFormToggle=!1})}function loadCampaign(){CreateCampaignService.load($routeParams.campaign_id).then(function(success){$scope.$emit("loading_finished"),$scope.campaign=success,$scope.campaign.profile_type_view_id||($scope.campaign.profile_type_view_id="0"),angular.forEach($scope.campaign.settings,function(value,index){var setting_name=value.name,setting_value=value.value;$scope.campaign[setting_name]=setting_value}),(!$scope.contributionEnabled||$scope.isStepFundingDelayed&&!$scope.campaign.ever_published)&&($scope.nextStepUrl="/campaign-preview/"+$routeParams.campaign_id),toggleProfileTypeViewText(),Restangular.one("campaign",$routeParams.campaign_id).one("stripe-account").customGET().then(function(stripe){stripe.length&&($scope.campaign.stripe_account_id=stripe[0].id)}),angular.forEach($scope.campaign.managers,function(value,index){if(campaignManagerId[index]=value.id,$scope.manager=value,value.person_websites){$scope.customlinks=value.person_websites;for(var n in $scope.customlinks){var current_profile_link=$scope.customlinks[n].uri;if("undefined"!=current_profile_link)for(var i in $scope.profile_protocols){var indexOf=current_profile_link.indexOf($scope.profile_protocols[i].value);if(indexOf>-1){$scope.customlinks[n].uri=current_profile_link.replace($scope.profile_protocols[i].value,""),$scope.customlinks[n].profile_link_default_protocol=$scope.profile_protocols[i].value;break}$scope.customlinks[n].profile_link_default_protocol=$scope.profile_protocols[2].value}}}}),1==campaignManagerId.length&&(paramID.person_id=campaignManagerId[0],getCompany()),$scope.campaign.business_organizations&&($scope.campaign.business_organizations.length&&($scope.companyFormToggle=!0),$scope.company_selected=$scope.campaign.business_organizations[0].business_organization_id,$scope.getBusinessLinks($scope.company_selected),$scope.getBusinessImage(),$scope.getDescription($scope.company_selected),$("#default-ctext").text($scope.campaign.business_organizations[0].name)),getAddress(paramID),getPhoneNumber(paramID),$scope.businessLinks=[]})}function getAddress(paramID){Restangular.one("account/").customGET("address",paramID).then(function(success){success?($scope.personal_address=success.personal,$scope.bussiness_address=success.business,$scope.bussiness_address?$scope.baddress_present=!0:$scope.baddress_present=!1,$scope.personal_address?$scope.paddress_present=!0:$scope.paddress_present=!1,$scope.campaign.business_organizations?checkAddress($scope.campaign.profile_type_id,$scope.campaign.business_organizations[0].business_organization_id):checkAddress($scope.campaign.profile_type_id,0)):($scope.setCountry($scope.selectedCountry.selected),null!=$scope.selectedCountry.selected&&Object.getOwnPropertyNames($scope.selectedCountry.selected).length&&getSubcountries($scope.selectedCountry.selected.id))})}function getPhoneNumber(paramID){Restangular.one("account/").customGET("phone-number",paramID).then(function(success){success.personal&&($scope.personalnumber=!0,$scope.personal_number=success.personal[0].number,$scope.pid=success.personal[0].phone_number_type_id,$scope.pphone_number_id=success.personal[0].phone_number_id,$scope.Ptype=checktype(success.personal[0].phone_number_type_id),$("#ptype").text($scope.Ptype)),success.business&&($scope.BusinessNumbers=success.business,checkNumber($scope.campaign.business_organizations?$scope.campaign.business_organizations[0].business_organization_id:0)),2==$scope.campaign.profile_type_id?$scope.phoneInfo.phone_number_type_id=$scope.bid:$scope.phoneInfo.phone_number_type_id=$scope.pid})}function checkNumber(id){var count=0;angular.forEach($scope.BusinessNumbers,function(v){v.business_organization_id==id&&($scope.businessnumber=!0,$scope.business_number=v.number,$scope.bid=v.phone_number_type_id,$scope.Btype=checktype(v.phone_number_type_id),$scope.bphone_number_id=v.phone_number_id,$("#btype").text($scope.Btype),count-=$scope.BusinessNumbers.length),count++,$scope.BusinessNumbers.length==count&&($scope.businessnumber=!1,$scope.business_number="",$scope.bid="",$scope.Btype="",$scope.bphone_number_id="")})}function checktype(id){var type;return angular.forEach($scope.phonetype,function(value){value.id==id&&(type=value.name)}),type}function checkAddress(id,bID){if($scope.address_ID="",$("#bselect_city").text(""),2==id){if($scope.bussiness_address){var count=0;angular.forEach($scope.bussiness_address,function(value){if(value.business_organization_id==bID){$scope.address_ID=value.address_id,$scope.baddress={city_id:value.city_id,mail_code:value.mail_code,street1:value.street1,street2:"",country_id:value.country_id};var business_address=1==$scope.native_lookup?getNativeName(value):value;if($scope.selectedCity.selected=value.city_full,$scope.alt_shipping){var countryObj={country:business_address.country,name:business_address.country,country_id:business_address.country_id,id:business_address.country_id,country_native_name:business_address.country_native_name},subcountryObj={subcountry:business_address.subcountry,name:business_address.subcountry,subcountry_id:business_address.subcountry_id,id:business_address.subcountry_id,subcountry_native_name:business_address.subcountry_native_name},cityObj={city:business_address.city,name:business_address.city,city_id:business_address.city_id,id:business_address.city_id,city_native_name:business_address.city_native_name};$scope.selectedCountry.selected=countryObj,$scope.setCountry($scope.selectedCountry.selected),$scope.selectedSubcountry.selected=subcountryObj,$scope.selectedCity.selected=cityObj}else $("#bselect_city").text($scope.selectedCity.selected);count-=$scope.bussiness_address.length}count++,$scope.bussiness_address.length==count&&($scope.baddress={city_id:"",mail_code:"",street1:"",street2:"",country_id:""})})}}else if($scope.personal_address){$scope.address={city_id:$scope.personal_address[0].city_id,mail_code:$scope.personal_address[0].mail_code,street1:$scope.personal_address[0].street1,street2:"",country_id:$scope.personal_address[0].country_id,address_id:$scope.personal_address[0].address_id};var personalAddress=$scope.personal_address[0];if(personalAddress=1==$scope.native_lookup?getNativeName(personalAddress):personalAddress,$scope.selectedCity.selected=personalAddress.city_full,$scope.alt_shipping){var countryObj={country:personalAddress.country,name:personalAddress.country,country_id:personalAddress.country_id,id:personalAddress.country_id,country_native_name:personalAddress.country_native_name},subcountryObj={subcountry:personalAddress.subcountry,name:personalAddress.subcountry,subcountry_id:personalAddress.subcountry_id,id:personalAddress.subcountry_id,subcountry_native_name:personalAddress.subcountry_native_name},cityObj={city:personalAddress.city,name:personalAddress.city,city_id:personalAddress.city_id,id:personalAddress.city_id,city_native_name:personalAddress.city_native_name};$scope.selectedCountry.selected=countryObj,$scope.setCountry($scope.selectedCountry.selected),$scope.selectedSubcountry.selected=subcountryObj,$scope.selectedCity.selected=cityObj}else $("#select_city").text($scope.selectedCity.selected)}}function getNativeName(addressObj){var name="";return null!=addressObj.country_native_name?(name+=addressObj.country_native_name,addressObj.country=addressObj.country_native_name):name+=addressObj.country,null!=addressObj.subcountry_native_name?(name+=" "+addressObj.subcountry_native_name,addressObj.subcountry=addressObj.subcountry_native_name):name+=" "+addressObj.subcountry,null!=addressObj.city_native_name&&"Other"!=addressObj.city?(name+=", "+addressObj.city_native_name,addressObj.city=addressObj.city_native_name):"Other"!=addressObj.city?name+=", "+addressObj.city:addressObj.city="",addressObj.city_full=name,addressObj.name=name,addressObj}function getCountries(){Geolocator.getCountries().then(function(countries){if($scope.native_lookup)for(var i in countries)null!=countries[i].native_name&&(countries[i].name=countries[i].native_name);if($scope.countries=countries,$scope.default_country){for(var index in $scope.countries){var value=$scope.countries[index];if(value.id==$scope.default_country.id){$scope.default_country=value,$scope.countries.splice(index,1);break}}$scope.countries.splice(0,0,$scope.default_country)}})}function getSubcountries(countryID){Geolocator.getSubcountriesByCountry(countryID).then(function(subcountries){if($scope.native_lookup)for(var i in subcountries)null!=subcountries[i].native_name&&(subcountries[i].name=subcountries[i].native_name);$scope.subcountries=subcountries})}function clearAddress(){$scope.selectedCity.selected=void 0,$scope.selectedSubcountry.selected=void 0,$scope.selectedCountry.selected=void 0,$scope.shipOptions=[],$scope.address.mail_code="",$scope.address.street1="",$scope.address.street2=""}function saveBusinessLinks(business_id,Protocols){if(Protocols)var selectedProtocols=Protocols;else var selectedProtocols=$(".dropdown.business-link-setup").dropdown("get text");angular.forEach($scope.businessLinks,function(link,key){var new_link={};for(var prop in link)new_link[prop]=link[prop],business_id&&(new_link.business_organization_id=business_id);Array.isArray(selectedProtocols)?"Relative Path"==selectedProtocols[key]?new_link.uri=link.uri:(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols[key]+link.uri):"Relative Path"==selectedProtocols?new_link.uri=link.uri:(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols+link.uri),new_link.uri&&(new_link.uri_id?Restangular.one("account/website",new_link.uri_id).customPUT(new_link):(link.business_organization_id=$scope.company_selected,Restangular.one("account/website").customPOST(new_link)))})}function savePhoneNumber(){$scope.personalnumber&&$scope.pphone_number_id?Restangular.one("account/phone-number",$scope.pphone_number_id).customPUT($scope.phoneInfo):""!=$scope.personalnumber&&Restangular.one("account/phone-number").customPOST($scope.phoneInfo)}function saveProfileLinks(Protocols){if(Protocols)var selectedProtocols=Protocols;else var selectedProtocols=$(".dropdown.profile-link-protocol").dropdown("get text");angular.forEach($scope.customlinks,function(link,key){var new_link={};for(var prop in link)new_link[prop]=link[prop];Array.isArray(selectedProtocols)?"Relative Path"!=selectedProtocols[key]?(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols[key]+link.uri):new_link.uri=link.uri:"Relative Path"!=selectedProtocols?(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols+link.uri):new_link.uri=link.uri,new_link.uri&&"http://"!=new_link.uri&&"https://"!=new_link.uri&&(new_link.id?Restangular.one("account/website",new_link.id).customPUT(new_link):(new_link.person_id=$scope.manager.id,Restangular.one("account/website").customPOST(new_link).then(function(success){})))})}function getNotes(){Restangular.one("campaign",$routeParams.campaign_id).one("note").customGET().then(function(success){success&&($scope.notes=success[0].value)})}$(document).on("keydown",".select2 .select2-search input",prevent_default_enter_key),$scope.uid=UserService.person_type_id,$scope.clearMessage=function(){$rootScope.floatingMessage=[]};var msg;$scope.campaign={},$scope.manager={},$scope.customlinks=[],$scope.selectedCity={},$scope.nextStepUrl="complete-funding/"+$routeParams.campaign_id;var campaignManagerId=($location.path().split("/")[1],[]),paramID={person_id:"",business_organization_id:""};$scope.businessImage=[],$scope.businessnumber=!1,$scope.selectedCity={},$scope.selectedSubcountry={},$scope.selectedCountry={},$scope.company={},PortalSettingsService.getSettingsObj().then(function(success){$scope.public_settings=success.public_setting,$scope.native_lookup=success.public_setting.site_theme_shipping_native_lookup,$scope.contributionEnabled=success.public_setting.site_campaign_contributions,$scope.isStepFundingDelayed=success.public_setting.site_theme_campaign_delayed_funding_setup,$scope.isRemoveUserProfileBio=success.public_setting.site_remove_user_profile_bio,$scope.public_settings.site_theme_campaign_show_reward_section?$scope.backUrl="rewards/"+$routeParams.campaign_id:$scope.backUrl="campaign-setup/"+$routeParams.campaign_id,2==$scope.public_settings.site_payment_gateway&&($scope.nextStepUrl="campaign-preview/"+$routeParams.campaign_id),$scope.direct_transaction=success.public_setting.site_campaign_fee_direct_transaction,$scope.direct_transaction&&($scope.nextStepUrl="campaign-preview/"+$routeParams.campaign_id),$scope.default_country=success.public_setting.site_theme_default_shipping_country,$scope.alt_shipping=success.public_setting.site_theme_alt_shipping_layout,$scope.alt_shipping&&getCountries(),$routeParams.campaign_id&&loadCampaign(),$scope.custom_field=[],Restangular.one("account/setting").customGET().then(function(success){success&&($scope.custom_field=success),$scope.public_settings.site_campaign_business_section_custom&&$scope.public_settings.site_campaign_business_section_custom.length>0&&($scope.bcustom=[],angular.forEach($scope.public_settings.site_campaign_business_section_custom,function(value){var fieldRequire=!1,fieldPlaceholder="";value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required);var field={name:value.name,value:"",placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field,function(val){val.name&&val.name==value.name&&(field.value=val.value)}),$scope.bcustom.push(field)}),$scope.bcustom_copy=angular.copy($scope.bcustom)),$scope.public_settings.site_campaign_personal_section_custom&&$scope.public_settings.site_campaign_personal_section_custom.length>0&&($scope.pcustom=[],angular.forEach($scope.public_settings.site_campaign_personal_section_custom,function(value){var fieldRequire=!1,fieldPlaceholder="";if(value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required),$scope.public_settings.site_campaign_personal_section_enhanced)var field={name:value.name,value:"",option:value.option,dropdown_array:value.dropdown_array,profile_step_show:value.profile_step_show,profile_setting_register_show:value.profile_setting_register_show,validate:value.validate,placeholder:fieldPlaceholder,required:fieldRequire};else var field={name:value.name,value:"",option:"Text",dropdown_array:null,profile_step_show:!0,placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field,function(val){val.name&&val.name==value.name&&(field.value=val.value)}),$scope.pcustom.push(field)}),$scope.pcustom_copy=angular.copy($scope.pcustom))})}),$scope.customFieldDropdown=function(option,field){field.value=option},$scope.phonetype=PHONE_TYPE;var trans_array=[];angular.forEach(PHONE_TYPE,function(value){trans_array.push(value.name)}),$translate(trans_array).then(function(translation){angular.forEach(translation,function(value,key){for(var i=0;i<$scope.phonetype.length;i++)$scope.phonetype[i].name==key&&($scope.phonetype[i].name=value)})});var profile_type_translation=$translate.instant(["profile_setup_toggle_view_on_campaign_both","profile_setup_toggle_view_on_campaign_business","profile_setup_toggle_view_on_campaign_user","Individual User Profile","Business Organization Profile"]);$scope.profileTypes=[{name:profile_type_translation["Individual User Profile"],profile_type_id:1},{name:profile_type_translation["Business Organization Profile"],profile_type_id:2}],$scope.profileTypesView=[{name:profile_type_translation.profile_setup_toggle_view_on_campaign_both,profile_type_view_id:0},{name:profile_type_translation.profile_setup_toggle_view_on_campaign_business,profile_type_view_id:1},{name:profile_type_translation.profile_setup_toggle_view_on_campaign_user,profile_type_view_id:2}],$scope.profileTypeViewSelected=function(typeID){$scope.campaign.profile_type_view_id=typeID,toggleProfileTypeViewText()},$scope.toggleProfileTypeViewText=function(){toggleProfileTypeViewText()},$scope.companyFormToggle=!1,$scope.newCompany={},$scope.newCompanyLogoID="";var imageFiles={};getNotes(),$scope.profileTypeSelected=function(typeID){$scope.campaign.profile_type_id!=typeID&&clearAddress(),$scope.campaign.profile_type_id=typeID,toggleProfileTypeViewText(),$scope.campaign.business_organizations?checkAddress($scope.campaign.profile_type_id,$scope.campaign.business_organizations[0].business_organization_id):checkAddress($scope.campaign.profile_type_id,0)},$scope.phoneInfo={number:"",phone_number_type_id:"",business_organization_id:"",person_id:""},$scope.phoneTypeSelected=function(type){$scope.phoneInfo.phone_number_type_id=type},$scope.setCountry=function(country){$scope.selectedCountry.selected=country},$scope.CompanyAddress=function(add){clearAddress(),checkAddress(2,add.business_organization_id),checkNumber(add.business_organization_id),$scope.company_selected=add.business_organization_id,$scope.getBusinessImage(),$scope.getBusinessLinks(add.business_organization_id)},$scope.address={city_id:"",mail_code:"",street1:"",street2:"",country_id:"",address_id:"",person_id:""},$scope.baddress={city_id:"",mail_code:"",street1:"",street2:"",country_id:"",business_organization_id:"",person_id:""},$scope.getDescription=function(bid){Restangular.one("account/business",bid).customGET().then(function(success){$scope.company.description=success.description})},$scope.getBusinessLinks=function(businessId){Restangular.all("account/website?business_organization_id="+businessId).customGET().then(function(success){$scope.businessLinks=success.business;for(var n in $scope.businessLinks){var current_business_link=$scope.businessLinks[n].uri;for(var i in $scope.profile_protocols){var indexOf=current_business_link.indexOf($scope.profile_protocols[i].value);if(indexOf>-1){$scope.businessLinks[n].uri=current_business_link.replace($scope.profile_protocols[i].value,""),$scope.businessLinks[n].profile_link_default_protocol=$scope.profile_protocols[i].value;break}$scope.businessLinks[n].profile_link_default_protocol=$scope.profile_protocols[2].value}}},function(failure){$scope.businessLinks=[]})},$scope.company_selected||($scope.company_selected={business_organization_id:"",description:"",name:""}),$scope.addBusinessLink=function(arr){var link={uri:"",uri_text:"",business_organization_id:$scope.company_selected};angular.isUndefined(arr)?$scope.businessLinks.push(angular.copy(link)):arr.push(angular.copy(link))},$scope.removeBusinessLink=function(link){link.uri_id?Restangular.one("account/website").customDELETE(link.uri_id,{business_organization_id:link.business_organization_id}).then(function(success){$scope.businessLinks.splice($scope.businessLinks.indexOf(link),1)}):$scope.businessLinks.splice($scope.businessLinks.indexOf(link),1)},$.fn.form.settings.rules.regexCustomValidation=function(value,validate){var regex=new RegExp(validate);return!value||!!regex&&regex.test(value)};var personalValidation=function(){var translation=$translate.instant(["tab_personal_setting_fname_validation","tab_personal_setting_lname_validation","tab_personal_setting_custom_field_validate","tab_personal_setting_custom_field_empty"]);$scope.form_validation={first_name:{identifier:"first_name",rules:[{type:"empty",prompt:translation.tab_personal_setting_fname_validation}]},last_name:{identifier:"last_name",rules:[{type:"empty",prompt:translation.tab_personal_setting_lname_validation}]}},angular.forEach($scope.pcustom,function(value,key){if(value.required&&!value.validate){var customValidate={identifier:value.name,rules:[{type:"empty",prompt:translation.tab_personal_setting_custom_field_empty}]};$scope.form_validation["customField"+key]=customValidate}else if(!value.required&&value.validate){var customValidate={identifier:value.name,rules:[{type:"regexCustomValidation["+value.validate+"]",prompt:translation.tab_personal_setting_custom_field_validate}]};$scope.form_validation["customField"+key]=customValidate}else if(value.required&&value.validate){var customValidate={identifier:value.name,rules:[{type:"empty",prompt:translation.tab_personal_setting_custom_field_empty},{type:"regexCustomValidation["+value.validate+"]",prompt:translation.tab_personal_setting_custom_field_validate}]};$scope.form_validation["customField"+key]=customValidate}}),$("form").form($scope.form_validation,{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=!0},onFailure:function(){$scope.valcheck=!1,$("html, body").animate({scrollTop:$(".field.error").offset().top},1e3)}}).form("validate form")};$scope.saveData=function($event){function updateAccSetting(settingObj){for(var i in settingObj)settingObj.hasOwnProperty(i)&&!settingObj[i]&&delete settingObj[i];Object.getOwnPropertyNames(settingObj).length&&Restangular.one("account/setting").customPUT(settingObj)}if($scope.valcheck=!1,personalValidation(),$scope.valcheck){if(1==$scope.campaign.profile_type_id)var selectedProtocols=$(".dropdown.profile-link-protocol").dropdown("get text");else var selectedProtocols=$(".dropdown.business-link-setup").dropdown("get text");var profile_type_data={toggle_profile_type_view_advance:$scope.campaign.toggle_profile_type_view_advance,profile_type_view_id:$scope.campaign.profile_type_view_id,charity_id:$scope.campaign.charity_id};Restangular.one("campaign/"+$routeParams.campaign_id+"/setting").customPUT(profile_type_data).then(function(success){msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()});var currentEle=$event.currentTarget,custom_setting=(!$(currentEle).hasClass("save-campaign-button"),{});if(angular.forEach($scope.bcustom,function(v){custom_setting[v.name]=v.value}),angular.forEach($scope.pcustom,function(v){custom_setting[v.name]=v.value}),$scope.custom_field=void 0==$scope.custom_field?[]:$scope.custom_field,$scope.custom_field.length>0){var delObj={};$scope.custom_field&&($scope.custom_field.forEach(function(value){delObj[value.name]=1}),Restangular.one("account").customDELETE("setting",delObj).then(function(success){updateAccSetting(custom_setting)},function(failed){updateAccSetting(custom_setting)}))}else updateAccSetting(custom_setting);if(2==$scope.campaign.profile_type_id)if($scope.phoneInfo.number=$scope.business_number,$scope.company_selected&&1==$scope.companyFormToggle){var data={business_organization_id:[$scope.company_selected],profile_type_id:$scope.campaign.profile_type_id,toggle_profile_type_view_advance:$scope.campaign.toggle_profile_type_view_advance};$scope.baddress.business_organization_id=$scope.company_selected,$scope.phoneInfo.business_organization_id=$scope.company_selected,$scope.baddress.person_id=paramID.person_id,$scope.phoneInfo.person_id=paramID.person_id,Restangular.one("campaign",$routeParams.campaign_id).customPUT(data).then(function(success){CreateCampaignService.cacheIn(success.plain()),$scope.address_ID&&$scope.baddress.city_id&&void 0!=$scope.baddress.street1&&void 0!=$scope.baddress.mail_code?Restangular.one("account/address",$scope.address_ID).customPUT($scope.baddress):$scope.baddress.city_id&&void 0!=$scope.baddress.street1&&void 0!=$scope.baddress.mail_code&&($scope.baddress.business_organization_id=$scope.company_selected,Restangular.one("account/address").customPOST($scope.baddress).then(function(success){$scope.address_ID=success.id})),$scope.businessnumber?(Restangular.one("account/phone-number",$scope.bphone_number_id).customPUT($scope.phoneInfo),$scope.businessnumber=!0):void 0!=$scope.phoneInfo.number&&""!=$scope.phoneInfo.number&&Restangular.one("account/phone-number").customPOST($scope.phoneInfo).then(function(success){});var busParam={description:$scope.company.description};for(var i in $scope.companies)if($scope.companies[i].id==$scope.company_selected){busParam.name=$scope.companies[i].name;break}saveBusinessLinks($scope.company_selected,selectedProtocols),Restangular.one("account/business",$scope.company_selected).customPUT(busParam).then(function(success){getCompany()})})}else if(0==$scope.companyFormToggle){var data={person_id:$scope.manager.id,name:$scope.newCompany.name,description:$scope.newCompany.description};$scope.company_selected||($scope.company_selected="");var fileParam={person_id:paramID.person_id,business_organization_id:$scope.company_selected,resource_content_type:"image"};0==$scope.companyFormToggle?Restangular.one("account/business").customPOST(data).then(function(success){data={business_organization_id:[success.id],profile_type_id:$scope.campaign.profile_type_id,toggle_profile_type_view_advance:$scope.campaign.toggle_profile_type_view_advance},$scope.phoneInfo.business_organization_id=success.id,$scope.baddress.business_organization_id=success.id,$scope.phoneInfo.person_id=paramID.person_id,$scope.baddress.person_id=paramID.person_id,Restangular.one("campaign",$routeParams.campaign_id).customPUT(data).then(function(success){CreateCampaignService.cacheIn(success.plain())}),$scope.companyFormToggle=!0,$scope.company.description=$scope.newCompany.description,$scope.newCompany={},$scope.companies.push(success),$scope.company_selected=success.business_organization_id,saveBusinessLinks($scope.company_selected,selectedProtocols),$scope.baddress.city_id&&void 0!=$scope.baddress.street1&&""!=$scope.baddress.screet1&&Restangular.one("account/address").customPOST($scope.baddress).then(function(success){$scope.address_ID=success.id}),$scope.business_number&&void 0!=$scope.business_number&&""!=$scope.business_number&&Restangular.one("account/phone-number").customPOST($scope.phoneInfo).then(function(success){}),fileParam.business_organization_id=success.id,0!=$scope.businessImage.length&&$scope.modifyBusinessImage(imageFiles,fileParam)},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}):($scope.baddress.business_organization_id=$scope.company_selected,$scope.phoneInfo.business_organization_id=$scope.company_selected,$scope.baddress.person_id=paramID.person_id,$scope.phoneInfo.person_id=paramID.person_id,Restangular.one("account/business",$scope.company_selected).customPUT(data).then(function(success){$scope.address_ID&&$scope.baddress.city_id&&void 0!=$scope.baddress.street1&&void 0!=$scope.baddress.mail_code?Restangular.one("account/address",$scope.address_ID).customPUT($scope.baddress):$scope.baddress.city_id&&void 0!=$scope.baddress.street1&&void 0!=$scope.baddress.mail_code&&($scope.baddress.business_organization_id=$scope.company_selected,Restangular.one("account/address").customPOST($scope.baddress).then(function(success){$scope.address_ID=success.id})),$scope.businessnumber?(Restangular.one("account/phone-number",$scope.bphone_number_id).customPUT($scope.phoneInfo),$scope.businessnumber=!0):void 0!=$scope.business_number&&""!=$scope.business_number&&Restangular.one("account/phone-number").customPOST($scope.phoneInfo)},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}if(1===$scope.campaign.profile_type_id&&(UserService.id==$scope.manager.id||1==UserService.person_type_id)){var data={profile_type_id:$scope.campaign.profile_type_id,toggle_profile_type_view_advance:$scope.campaign.toggle_profile_type_view_advance};Restangular.one("campaign",$routeParams.campaign_id).customPUT(data).then(function(success){$scope.phoneInfo.number=$scope.personal_number,$scope.phoneInfo.person_id=$scope.manager.person_id;var accountData={first_name:$scope.manager.first_name,last_name:$scope.manager.last_name,bio:$scope.manager.bio};$scope.address.person_id=paramID.person_id,$scope.paddress_present?$scope.address.city_id&&$scope.address.street1&&$scope.address.mail_code&&Restangular.one("account/address",$scope.address.address_id).customPUT($scope.address):Restangular.one("account/address").customPOST($scope.address),savePhoneNumber(),UserService.id==$scope.manager.id?(accountData.person_id=$scope.manager.person_id,Restangular.one("account").customPUT(accountData).then(function(success){UserService.id==$scope.manager.id&&UserService.updateUserData(accountData)})):1==UserService.person_type_id&&(accountData.person_id=$scope.manager.person_id,Restangular.one("portal/person",$scope.manager.person_id).customPUT(accountData)),saveProfileLinks(selectedProtocols)})}}},$scope.profile_protocols=[{value:"http://"},{value:"https://"},{value:"Relative Path"}],$scope.profile_link_default_protocol=$scope.profile_protocols[0],$scope.addLink=function(arr){var link={uri:"",uri_text:""};return angular.isUndefined(arr)?angular.copy(link):arr.push(angular.copy(link))},$scope.removeProfileLink=function(link,index){link.id&&Restangular.one("account/website",link.id).customDELETE().then(function(success){}),$scope.customlinks.splice(index,1)},$scope.dimmerOn=function(){$(".image").dimmer("show")},$scope.dimmerOff=function(){$(".image").dimmer("hide")},$scope.uploadProfileImage=function(files){if(($scope.manager.id==UserService.id||1==UserService.person_type_id)&&files.length)if($scope.allowedImage(files[0].type)){var params={resource_content_type:"image",person_id:$scope.manager.id},$picNode=$(".profileSetup");null==$scope.manager.person_files||0==$scope.manager.person_files.length?FileUploadService.upload("account/resource/file/",files,params,$picNode).then(function(success){success.length&&($scope.manager.person_files=[],$scope.manager.person_files.push(success[0].data))}):FileUploadService.modify("account/resource/file/",files,params,$scope.manager.person_files[0].id,$picNode).then(function(success){success.length&&($scope.manager.person_files=[],$scope.manager.person_files.push(success[0].data))})}else $(".wrong-filetype").modal("show")},$scope.allowedImage=function(file_type){var allowed_type=["image/vnd.microsoft.icon","image/x-icon","image/png","image/pjpeg","image/jpeg","image/gif"];return allowed_type.indexOf(file_type)>-1},$scope.deleteProfileImage=function(files){if(files&&files.length){var file=files.pop();Restangular.one("account/resource/file").customDELETE(file.id),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.progress.upload-bar").show(),$(".ui.loader.download-loader").hide()}},$scope.uploadBusinessImage=function(files){if((UserService.id==$scope.manager.id||1==UserService.person_type_id)&&files.length){var params={};if(params=$scope.companyFormToggle?{resource_content_type:"image",business_organization_id:$scope.company_selected,
person_id:paramID.person_id}:{resource_content_type:"image",person_id:paramID.person_id},$scope.companyFormToggle){var $picNode=$(".profileCompany");0==$scope.businessImage.length?FileUploadService.upload("account/resource/file/",files,params,$picNode).then(function(success){$scope.getBusinessImage(),$scope.newCompanyLogoID=success[0].data.id}):FileUploadService.modify("account/resource/file/",files,params,$scope.businessImage[0].id,$picNode).then(function(success){$scope.getBusinessImage(),$scope.newCompanyLogoID=success[0].data.id})}else $scope.company_selected={},$scope.company_selected.name="Placeholder",Restangular.one("account/business").customPOST($scope.company_selected).then(function(success){$scope.company_selected=success.id,params.business_organization_id=$scope.company_selected;var $picNode=$(".profileCompany");0==$scope.businessImage.length?FileUploadService.upload("account/resource/file/",files,params,$picNode).then(function(success){$scope.getBusinessImage(),$scope.newCompanyLogoID=success[0].data.id}):FileUploadService.modify("account/resource/file/",files,params,$scope.businessImage[0].id,$picNode).then(function(success){$scope.getBusinessImage(),$scope.newCompanyLogoID=success[0].data.id});var data={business_organization_id:[$scope.company_selected],entry_id:$routeParams.campaign_id};Restangular.one("campaign",$routeParams.campaign_id).customPUT(data).then(function(success){},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})})}},$scope.modifyBusinessImage=function(files,params){FileUploadService.upload("account/resource/file",files,params).then(function(success){$scope.businessImage=[],$scope.businessImage.push(success[0].data)})},$scope.deleteBusinessImage=function(files){if(files&&files.length){var file=files.pop(),param={business_organization_id:$scope.company_selected};Restangular.one("account/resource/file").customDELETE(file.id,param),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.progress.upload-bar").show(),$(".ui.loader.download-loader").hide()}},$scope.getBusinessImage=function(){if($scope.businessImage=[],null!=$scope.company_selected&&void 0!=$scope.company_selected){var dataParam={business_organization_id:$scope.company_selected,person_id:paramID.person_id};Restangular.one("account/resource").customGET("file",dataParam).then(function(success){$scope.businessImage=success})}},$scope.cities=[],$scope.searchCities=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&($scope.alt_shipping?Geolocator.searchCitiesBySubcountry(term,$scope.selectedSubcountry.selected.id,native_lookup).then(function(cities){if(native_lookup)for(var i in cities)null!=cities[i].city_native_name&&(cities[i].name=cities[i].city_native_name),null!=cities[i].country_native_name&&(cities[i].country=cities[i].country_native_name),null!=cities[i].subcountry_native_name&&(cities[i].subcountry=cities[i].subcountry_native_name);$scope.cities=cities}):Geolocator.searchCities(term,native_lookup).then(function(cities){native_lookup&&cities.forEach(function(value,index){value=getNativeName(value)}),$scope.cities=cities}))},$scope.searchCitiesbusiness=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&($scope.alt_shipping?Geolocator.searchCitiesBySubcountry(term,$scope.selectedSubcountry.selected.id,native_lookup).then(function(cities){if(native_lookup)for(var i in cities)null!=cities[i].city_native_name&&(cities[i].name=cities[i].city_native_name),null!=cities[i].country_native_name&&(cities[i].country=cities[i].country_native_name),null!=cities[i].subcountry_native_name&&(cities[i].subcountry=cities[i].subcountry_native_name);$scope.cities=cities}):Geolocator.searchCities(term,native_lookup).then(function(cities){native_lookup&&cities.forEach(function(value,index){value=getNativeName(value)}),$scope.cities=cities}))},$scope.newOrExistComp=function(){var $compBtn=$("#compBtn");$scope.companyFormToggle=!$scope.companyFormToggle,$scope.companyFormToggle?($compBtn.css("margin-top","0px"),getAddress(paramID),getPhoneNumber(paramID),$scope.getBusinessImage()):($scope.selectedCountry.selected=!1,$scope.selectedSubcountry.selected=!1,$scope.selectedCity.selected=!1,$scope.baddress.street1="",$("#bselect_city").text(""),$scope.baddress.mail_code="",$scope.business_number="",$scope.businessImage=[],$scope.businessLinks=[],$compBtn.css("margin-top","5px"))},$scope.$watch("selectedCountry.selected",function(value,oldValue){value!=oldValue&&value&&getSubcountries(value.id)}),$scope.$watch("selectedCity.selected",function(value){value&&(cityID=Geolocator.lookupCityID(value.name),cityID&&(2==$scope.campaign.profile_type_id?($scope.baddress.city_id=cityID,$("#bselect_city").text(value.name)):($scope.address.city_id=cityID,$("#select_city").text(value.name))),countryID=Geolocator.lookupCountryID(value.name),countryID&&(2==$scope.campaign.profile_type_id?$scope.baddress.country_id=countryID:$scope.address.country_id=countryID))}),$scope.$watch("bselectedCity.selected",function(value){value&&(cityID=Geolocator.lookupCityID(value.name),cityID&&($scope.baddress.city_id=cityID),countryID=Geolocator.lookupCountryID(value.name),countryID&&($scope.baddress.country_id=countryID))}),$scope.$watch("address.country_id",function(countryID){var worldWide=null,country=null;countryID&&(angular.forEach($scope.shippingOption,function(item,key){item.country_id==countryID&&(country=key),1==item.shipping_option_type_id&&(worldWide=key)}),null!=country?$scope.costIndex=country:null!=worldWide&&($scope.costIndex=worldWide))})}]);